<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket Test</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs/lib/stomp.min.js"></script>
</head>
<body>

<h2>WebSocket Chat</h2>

<label for="chatId">Chat ID:</label>
<input type="text" id="chatId" placeholder="Введите chatId">
<br><br>

<label for="message">Message:</label>
<input type="text" id="message" placeholder="Введите сообщение">
<button onclick="sendMessage()">Отправить</button>

<h3>Сообщения:</h3>
<div id="messages"></div>

<script>
    let stompClient = null;
    let chatId = "";

    function connect() {
        const token = "YOUR_JWT_TOKEN";
        const socket = new SockJS(`http://localhost:8080/ws?token=${token}`);
        stompClient = Stomp.over(socket);

        stompClient.connect(
            { Authorization: `Bearer ${token}` }, // Передаем токен в заголовке
            function (frame) {
                console.log("Connected: " + frame);
                chatId = document.getElementById("chatId").value;

                if (chatId) {
                    stompClient.subscribe("/topic/messages/" + chatId, function (message) {
                        showMessage(JSON.parse(message.body));
                    });
                    console.log("Subscribed to: /topic/messages/" + chatId);
                } else {
                    console.log("Введите chatId перед подпиской.");
                }
            },
            function (error) {
                console.error("Ошибка подключения: ", error);
            }
        );
    }

    function sendMessage() {
        const text = document.getElementById("message").value;
        chatId = document.getElementById("chatId").value;

        if (!chatId) {
            alert("Введите chatId!");
            return;
        }

        const messageObj = {
            chatId: chatId,
            text: text,
            isRead: false,
            isDeleted: false,
            isEdited: false,
            timestamp: new Date().getTime()
        };

        stompClient.send("/app/send/" + chatId, {}, JSON.stringify(messageObj));
    }

    function showMessage(message) {
        const messagesDiv = document.getElementById("messages");
        const messageElement = document.createElement("p");
        messageElement.textContent = "ChatId: " + message.chatId + " | " + message.text;
        messagesDiv.appendChild(messageElement);
    }

    window.onload = function () {
        connect();
    };
</script>

</body>
</html>